<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse - Flash Energy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
  <link rel="stylesheet" href="itemstyle.css">
</head>
<body>
  <div class="container">
    <!-- üîç Search box -->
    <div class="search-container">
      <input type="text" placeholder="Search..." class="search-input" id="searchInput">
      <button id="searchBtn" class="search-btn">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </div>

    <h5 class="mt-4 items-title">ITEMS</h5>

    <!-- üü¢ Add Item Form -->
    <div id="receiveTable" class="receive-container">
      <form id="itemForm">
        <div class="input-row">
          <input id="productname" name="productname" type="text" class="rounded-input animated-select" placeholder="Model" required>
          <input id="qty" name="qty" type="number" class="rounded-input animated-select" min="1" value="1" placeholder="Qty" required>
          <select id="unit" name="unit" class="rounded-input animated-select">
            <option>Pcs</option><option>kg</option><option>ltr</option><option>m</option>
          </select>
          <select id="warehouse" name="warehouse" class="rounded-input animated-select">
            <option>ŸÖÿÆÿ≤ŸÜ ŸÅŸäÿµŸÑ</option><option>ŸÑÿ®ŸäŸÜŸä</option><option>ÿ®ÿßÿ® ÿßŸÑŸàŸÇ</option>
          </select>
          <div class="actions">
            <button type="submit" class="icon-btn add"><i class="fa-solid fa-plus"></i></button>
          </div>
        </div>
      </form>
    </div>

    <!-- üìã Items Table -->
    <div class="table-responsive mt-3">
      <table id="receiveTable" class="custom-table">
        <thead>
          <tr>
            <th>#</th><th>Barcode</th><th>Model</th><th>Qty</th><th>Unit</th><th>Warehouse</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="itemsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- üîπ Transfer Modal -->
  <div id="transferModal" class="modal">
    <div class="modal-content">
      <h3>Transfer Item</h3>
      <p><b>Current Warehouse:</b> <span id="currentWarehouseText"></span></p>
      <input type="number" id="transferQty" min="1" placeholder="Quantity">
      <select id="targetWarehouse"></select>
      <div class="modal-actions">
        <button class="btn-confirm" id="confirmTransfer">Confirm</button>
        <button class="btn-cancel" id="cancelTransfer">Cancel</button>
      </div>
    </div>
  </div>

  <!-- üîπ Logs Modal -->
  <div id="logsModal" style="
    display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:#fff; padding:20px; border-radius:10px; width:90%; max-width:800px;
    box-shadow:0 5px 20px rgba(0,0,0,0.3); z-index:1000; overflow:auto; max-height:70%;
  ">
    <h3 style="margin-top:0;">Action Logs</h3>
    <table id="logsTable" style="width:100%; border-collapse:collapse; font-family:Arial,sans-serif; font-size:14px;">
      <thead>
        <tr style="background:#0fd12f; color:#fff;">
          <th style="border:1px solid #ddd; padding:8px;">#</th>
          <th style="border:1px solid #ddd; padding:8px;">User</th>
          <th style="border:1px solid #ddd; padding:8px;">Email</th>
          <th style="border:1px solid #ddd; padding:8px;">Action</th>
          <th style="border:1px solid #ddd; padding:8px;">Details</th>
          <th style="border:1px solid #ddd; padding:8px;">Time</th>
        </tr>
      </thead>
      <tbody id="logsContent"></tbody>
    </table>
    <button id="closeLogs" style="
      margin-top:15px; padding:8px 15px; border:none; border-radius:5px;
      background:#0fd12f; color:#fff; cursor:pointer;">Close</button>
  </div>

  <!-- üîπ Logs Button -->
  <button id="showLogsBtn" style="
    display:none;
    position:fixed; bottom:20px; right:20px; padding:10px 15px;
    background:#48dbfb; border:none; border-radius:5px; cursor:pointer; z-index:100;">
    Show Logs
  </button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCipCX2qabmYwOxUpJr07M0O1n4e6OTNrk",
  authDomain: "flashenergy-35783.firebaseapp.com",
  databaseURL: "https://flashenergy-35783-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "flashenergy-35783",
  storageBucket: "flashenergy-35783.appspot.com",
  messagingSenderId: "661915550417",
  appId: "1:661915550417:web:d461c040fc6acfec593bf0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser = { username: "", email: "" };
const allowedUsers = [
  "flashgroup17@gmail.com",
  "mh8891287@gmail.com",
  "hamdyfg@gmail.com",
  "hamdyyousef75@gmail.com"
];

const showLogsBtn = document.getElementById("showLogsBtn");
const logsModal = document.getElementById("logsModal");
const logsContent = document.getElementById("logsContent");
const closeLogs = document.getElementById("closeLogs");

// ‚úÖ Always use Authentication for email
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser.email = user.email;
    currentUser.username = user.displayName || "Unknown";

    // Show button if email is allowed
    if (allowedUsers.includes(user.email)) {
      showLogsBtn.style.display = "block";
    }

    // Ensure DB has user entry
    const userRef = ref(db, "users/" + user.uid);
    onValue(userRef, (snapshot) => {
      if (!snapshot.exists()) {
        set(userRef, { username: currentUser.username, email: currentUser.email });
      } else {
        const data = snapshot.val();
        currentUser.username = data.username || currentUser.username;
      }
    }, { onlyOnce: true });

  } else {
    window.location.href = "index.html";
  }
});

function logAction(actionType, details) {
  const logsRef = ref(db, "logs");
  const newLogRef = push(logsRef);
  set(newLogRef, {
    user: currentUser.username,
    email: currentUser.email,
    action: actionType,
    details: details,
    timestamp: new Date().toISOString()
  });
}

const itemForm = document.getElementById("itemForm");
const itemsTable = document.getElementById("itemsTable");

// Add new item
itemForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const productname = document.getElementById("productname").value;
  const qty = document.getElementById("qty").value;
  const unit = document.getElementById("unit").value;
  const warehouse = document.getElementById("warehouse").value;
  const itemsRef = ref(db, "items");
  const newItemRef = push(itemsRef);
  set(newItemRef, { productname, qty, unit, warehouse }).then(() => itemForm.reset());
  logAction("add", { productname, qty, unit, warehouse });
});

// Display items table
const itemsRef = ref(db, "items");
onValue(itemsRef, (snapshot) => {
  itemsTable.innerHTML = "";
  let count = 1;
  snapshot.forEach((child) => {
    const item = child.val();
    itemsTable.innerHTML += `
      <tr data-id="${child.key}">
        <td>${count++}</td>
        <td>${child.key}</td>
        <td>${item.productname}</td>
        <td>${item.qty}</td>
        <td>${item.unit}</td>
        <td>${item.warehouse}</td>
        <td>
          <button class="icon-btn delete"><i class="fa-solid fa-trash"></i></button>
          <button class="icon-btn edit"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="icon-btn warehouse"><i class="fa-solid fa-warehouse"></i></button>
        </td>
      </tr>`;
  });

  // ‚úÖ ŸÑÿßÿ≤ŸÖ ŸÜÿ∂ŸäŸÅ ÿßŸÑlisteners ÿ®ÿπÿØ ŸÖÿß ŸÜÿ±ŸÜÿØÿ± ÿßŸÑÿµŸÅŸàŸÅ
  document.querySelectorAll(".delete").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const row = e.target.closest("tr");
      const id = row.getAttribute("data-id");
      remove(ref(db, "items/" + id));
      logAction("delete", { id });
    });
  });

  document.querySelectorAll(".edit").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const row = e.target.closest("tr");
      const id = row.getAttribute("data-id");
      const tds = row.querySelectorAll("td");

      const oldData = {
        productname: tds[2].textContent,
        qty: tds[3].textContent,
        unit: tds[4].textContent,
        warehouse: tds[5].textContent
      };

      // Replace cells with inputs
      tds[2].innerHTML = `<input type="text" value="${oldData.productname}" />`;
      tds[3].innerHTML = `<input type="number" value="${oldData.qty}" />`;
      tds[4].innerHTML = `
        <select>
          <option ${oldData.unit === "kg" ? "selected" : ""}>kg</option>
          <option ${oldData.unit === "litre" ? "selected" : ""}>litre</option>
          <option ${oldData.unit === "piece" ? "selected" : ""}>piece</option>
        </select>
      `;
      tds[5].innerHTML = `
        <select>
          <option ${oldData.warehouse === "A" ? "selected" : ""}>A</option>
          <option ${oldData.warehouse === "B" ? "selected" : ""}>B</option>
          <option ${oldData.warehouse === "C" ? "selected" : ""}>C</option>
        </select>
      `;

      // Change action buttons
      tds[6].innerHTML = `
        <button class="icon-btn save"><i class="fa-solid fa-check"></i></button>
        <button class="icon-btn cancel"><i class="fa-solid fa-xmark"></i></button>
      `;

      // ‚úÖ Save event
      tds[6].querySelector(".save").addEventListener("click", () => {
        const newData = {
          productname: tds[2].querySelector("input").value,
          qty: tds[3].querySelector("input").value,
          unit: tds[4].querySelector("select").value,
          warehouse: tds[5].querySelector("select").value
        };

        update(ref(db, "items/" + id), newData);

        logAction("edit", { before: oldData, after: newData });
      });

      // ‚ùå Cancel event
      tds[6].querySelector(".cancel").addEventListener("click", () => {
        tds[2].textContent = oldData.productname;
        tds[3].textContent = oldData.qty;
        tds[4].textContent = oldData.unit;
        tds[5].textContent = oldData.warehouse;

        tds[6].innerHTML = `
          <button class="icon-btn delete"><i class="fa-solid fa-trash"></i></button>
          <button class="icon-btn edit"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="icon-btn warehouse"><i class="fa-solid fa-warehouse"></i></button>
        `;
      });
    });
  });


// üîπ Logs Modal functionality
showLogsBtn.addEventListener("click", () => {
  logsContent.innerHTML = "";
  onValue(ref(db, "logs"), (snapshot) => {
    let count = 1;
    logsContent.innerHTML = "";
    snapshot.forEach(child => {
      const log = child.val();

      // üîπ Format details
      let detailsHtml = "";
      if (log.details?.before || log.details?.after) {
        if (log.details.before) {
          detailsHtml += `<b>Before:</b><br>`;
          Object.entries(log.details.before).forEach(([key, val]) => {
            detailsHtml += `${key}: ${val}<br>`;
          });
        }
        if (log.details.after) {
          detailsHtml += `<b>After:</b><br>`;
          Object.entries(log.details.after).forEach(([key, val]) => {
            detailsHtml += `${key}: ${val}<br>`;
          });
        }
      } else {
        // fallback for simple actions (like add/delete without before/after)
        Object.entries(log.details || {}).forEach(([key, val]) => {
          detailsHtml += `${key}: ${val}<br>`;
        });
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="border:1px solid #ddd; padding:8px;">${count++}</td>
        <td style="border:1px solid #ddd; padding:8px;">${log.user}</td>
        <td style="border:1px solid #ddd; padding:8px;">${log.email}</td>
        <td style="border:1px solid #ddd; padding:8px;">${log.action}</td>
        <td style="border:1px solid #ddd; padding:8px; white-space:pre-line;">${detailsHtml}</td>
        <td style="border:1px solid #ddd; padding:8px;">${new Date(log.timestamp).toLocaleString()}</td>
      `;
      logsContent.appendChild(row);
    });
  }, { onlyOnce: true });
  logsModal.style.display = "block";
});

closeLogs.addEventListener("click", () => {
  logsModal.style.display = "none";
});

</script>

</body>
<script src="compileitem.js"></script>
</html>
